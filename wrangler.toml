name = "grok2api"
main = "src/index.ts"
compatibility_date = "2026-01-28"
minify = true

# 静态资源（Vue SPA）
[assets]
directory = "./web/dist"
binding = "ASSETS"
# SPA 路由统一回退到 index.html，避免 /admin/* 等前端路由被当作静态文件后重定向。
not_found_handling = "single-page-application"
# 禁用 HTML 自动斜杠规范化，避免多余 307。
html_handling = "none"
# 仅让动态路径进入 Worker，其余前端路由交给静态资产层。
run_worker_first = ["/api/*", "/v1/*", "/images/*", "/health", "/manage", "/admin/chat", "/_worker.js"]

# 将执行位置固定在美国附近，使出口流量更稳定。
# 文档: https://developers.cloudflare.com/workers/platform/placement/
[placement]
region = "aws:us-east-1"

[[d1_databases]]
binding = "DB"
database_name = "grok2api"
# 由 CI 或首次部署填充。
database_id = "REPLACE_WITH_D1_DATABASE_ID"
migrations_dir = "migrations"

[[kv_namespaces]]
binding = "KV_CACHE"
# 由 CI 或首次部署填充。
id = "REPLACE_WITH_KV_NAMESPACE_ID"

[[queues.producers]]
binding = "TOKEN_USAGE_REFRESH_QUEUE"
queue = "grok2api-token-usage-refresh"

[[queues.consumers]]
queue = "grok2api-token-usage-refresh"
max_batch_size = 25
max_batch_timeout = 3
max_retries = 5
retry_delay = 20

# Durable Objects 迁移历史：
# - do-v1 创建了 AutoRegisterJob（现已移除）
# - do-v2 删除它，使 Worker 可以在不导出类的情况下部署
[[migrations]]
tag = "do-v1"
new_sqlite_classes = ["AutoRegisterJob"]

[[migrations]]
tag = "do-v2"
deleted_classes = ["AutoRegisterJob"]

[vars]
# 每日在本地午夜重置（默认：Asia/Shanghai, UTC+8）。
# 确保下方的 cron 时间与此偏移量匹配。
CACHE_RESET_TZ_OFFSET_MINUTES = "480"

# 构建信息（CI 会将 commit SHA 注入到 wrangler.ci.toml）
BUILD_SHA = "dev"

# Workers KV 单值有限制；保持 <= 25MB。
KV_CACHE_MAX_BYTES = "26214400"

# 每日清理任务的批处理大小（删除 KV 键和 D1 行）。
KV_CLEANUP_BATCH = "200"

[triggers]
# 每日 00:00（Asia/Shanghai => 16:00 UTC）
crons = ["0 16 * * *"]
